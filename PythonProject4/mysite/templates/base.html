{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Django Auth{% endblock %}</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@100;300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>

    <!-- Navigation -->
    <nav class="navigation">
        {% if user.is_authenticated %}
            <div class="nav-left">
                <a href="{% url 'home' %}">Home</a>
                <a href="{% url 'notifications' %}">Notifications</a>
                <a href="{% url 'chat_list' %}">Messages</a>
            </div>

            <div class="nav-right">
                <p class="username"><strong>{{ user.username }}</strong></p>
                <div class="profile-buttons">
                    <a href="{% url 'profile' %}">Profile</a>
                    <a href="{% url 'logout' %}">Logout</a>
                </div>
            </div>
        {% else %}
            <div class="nav-left"><a href="{% url 'home' %}">Home</a></div>
            <div class="nav-right">
                <div class="profile-buttons-loggedout">
                    <strong>
                        <a href="{% url 'login' %}">Login</a>
                        <a href="{% url 'register' %}">Register</a>
                    </strong>
                </div>
            </div>
        {% endif %}
    </nav>

    <!-- Main Page Content -->
    <div class="container">
        {% block content %}
        {% endblock %}
    </div>

    <!-- ✅ CHAT WIDGET -->
    {% if user.is_authenticated %}
    <button id="chat-toggle">Chat</button>

    <div id="widget-chat-window">
        <!-- Header -->
        <div id="widget-chat-header">
            <strong>Chat</strong>
            <span id="chat-close" style="cursor:pointer;">X</span>
        </div>

        <!-- Users List -->
        <div id="chat-user-list">
            <p><strong>Users:</strong></p>
            {% if other_users %}
                {% for u in other_users %}
                    <button class="chat-user-button" data-user-id="{{ u.id }}">{{ u.username }}</button>
                {% endfor %}
            {% else %}
                <p>No other users.</p>
            {% endif %}
        </div>

        <!-- Chat Content -->
        <div id="widget-chat-content" style="display:none; flex-direction: column; height: 100%;">
            <button id="back-to-users" style="display:none; margin:0.5em; background:#028090; color:white; border:none; border-radius:0.3em; cursor:pointer;">
                ← Back to Users
            </button>
            <div id="chat-messages" style="flex:1; overflow-y:auto; padding:0.5em; display:flex; flex-direction:column; gap:0.5em;"></div>
            <form id="chat-form" style="display:flex; padding:0.25em; border-top:0.05em solid #ddd; background:#f5f5f5;">
                {% csrf_token %}
                <textarea id="chat-input" name="content" placeholder="Type a message..." rows="2" style="flex:1; resize:none; min-height:3em; max-height:6em; border-radius:0.2em; border:0.05em solid #ccc; padding:0.25em;"></textarea>
                <button type="submit" style="background:#007bff; color:white; border:none; padding:0.25em 0.5em; margin-left:0.25em; cursor:pointer; border-radius:0.2em;">Send</button>
            </form>
        </div>
    </div>
    {% endif %}

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const chatToggle = document.getElementById("chat-toggle");
            const chatWindow = document.getElementById("widget-chat-window");
            const chatClose = document.getElementById("chat-close");
            const userButtons = document.querySelectorAll(".chat-user-button");
            const chatMessages = document.getElementById("chat-messages");
            const chatBox = document.getElementById("widget-chat-content");
            const chatForm = document.getElementById("chat-form");
            const chatInput = document.getElementById("chat-input");
            const userListDiv = document.getElementById("chat-user-list");
            const backBtn = document.getElementById("back-to-users");

            let activeUserId = null;

            function scrollToBottom() {
                requestAnimationFrame(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }


            function loadChat(userId) {
                fetch(`/chat/widget/${userId}`)
                    .then(res => res.text())
                    .then(html => {
                        chatMessages.innerHTML = html;
                        userListDiv.style.display = "none";
                        backBtn.style.display = "block";
                        chatBox.style.display = "flex";
                        activeUserId = userId;
                        scrollToBottom();
                    });
            }


            // Open chat widget
            chatToggle.addEventListener("click", () => {
                chatWindow.style.display = "flex";
                chatWindow.classList.add("open");
                chatToggle.style.display = "none";
            });

            // Close widget
            chatClose.addEventListener("click", () => {
                chatWindow.classList.remove("open");
                setTimeout(() => {
                    chatWindow.style.display = "none";
                    chatToggle.style.display = "block";
                }, 250);
            });

            // Close on ESC
            document.addEventListener("keydown", function(e) {
                if (e.key === "Escape" || e.key === "Esc") {
                    if (chatWindow.classList.contains("open")) {
                        chatWindow.classList.remove("open");
                        setTimeout(() => {
                            chatWindow.style.display = "none";
                            chatToggle.style.display = "block";
                        }, 250);
                    }
                }
            });

            // User click
            userButtons.forEach(btn => {
                btn.addEventListener("click", function () {
                    const userId = this.dataset.userId;
                    loadChat(userId);
                });
            });

            // Back to users
            backBtn.addEventListener("click", () => {
                chatBox.style.display = "none";
                userListDiv.style.display = "block";
                backBtn.style.display = "none";
                activeUserId = null;
            });

            // Textarea auto-grow
            chatInput.addEventListener("input", function() {
                chatInput.style.height = "auto";
                chatInput.style.height = chatInput.scrollHeight + "px";
            });

            // Submit message
            chatInput.addEventListener("keydown", function(e) {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    chatForm.requestSubmit();
                }
            });

            chatForm.addEventListener("submit", async function(e) {
                e.preventDefault();
                if (!activeUserId) return;
                const content = chatInput.value.trim();
                if (!content) return;
                const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

                let response = await fetch(`/chat/${activeUserId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrfToken,
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: "content=" + encodeURIComponent(content)
                });

                if (response.ok) {
                    chatInput.value = "";
                    chatInput.style.height = "auto";
                    loadChat(activeUserId);
                }
            });
        });
    </script>

</body>
</html>
